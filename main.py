# pip install requests if needed
import requests
import json

def display_cves(num_cves):
    url = 'https://access.redhat.com/hydra/rest/securitydata/cve.json'
    
    response = requests.get(url)

    if response.status_code == 200:
        cve_data = json.loads(response.content)

        print("Vous préférez afficher les CVEs dans un fichier JSON ou un fichier texte ?")
        print("1. JSON")
        print("2. Texte")
        print("3. Les deux (JSON et texte")
        format = input("Entrez votre choix : ")
        
        if format == '1':
            with open('cves.json', 'w') as f:
                json.dump(cve_data, f, indent=4)
        
        elif format == '2':
            with open('cves.txt', 'w') as f:
                for cve in cve_data[:num_cves]:
                    print(f"Numéro CVE : {cve['CVE']}", file=f)
                    print(f"Date de publication : {cve['public_date']}", file=f)
                    print(f"Sévérité : {cve['severity']}", file=f)
                    print(f"Description: {cve['bugzilla_description']}", file=f)
                    print(f"CVSS score: {cve['cvss3_score']}", file=f)
                    print(f"Plus d'info: {cve['resource_url']}", file=f)
                    print("", file=f)
                    print("", file=f)
        elif format == '3':
            with open('cves.txt', 'w') as f:
                for cve in cve_data[:num_cves]:
                    print(f"Numéro CVE : {cve['CVE']}", file=f)
                    print(f"Date de publication : {cve['public_date']}", file=f)
                    print(f"Sévérité : {cve['severity']}", file=f)
                    print(f"Description: {cve['bugzilla_description']}", file=f)
                    print(f"CVSS score: {cve['cvss3_score']}", file=f)
                    print(f"Plus d'info: {cve['resource_url']}", file=f)
                    print("", file=f)
                    print("", file=f)
            with open('cves.json', 'w') as f:
                json.dump(cve_data, f, indent=4)
        else: 
            print("Choix invalide. Veuillez sélectionner une option valide.")
            exit()
        
        for cve in cve_data[:num_cves]:
            print(f"Numéro CVE : {cve['CVE']}")
            print(f"Date de publication : {cve['public_date']}")
            print(f"Sévérité : {cve['severity']}")
            print(f"Description: {cve['bugzilla_description']}")
            print(f"CVSS score: {cve['cvss3_score']}")
            print(f"Plus d'info: {cve['resource_url']}")
            print("")
            print("") 
    else:
        print('Erreur lors de la récupération des données :', response.status_code)

def display_cve_info(cve_id):
    url = f'https://access.redhat.com/hydra/rest/securitydata/cve/{cve_id}'

    response = requests.get(url)

    if response.status_code == 200:
        cve_info = json.loads(response.content)

        with open(f'{cve_id}.txt', 'w') as f:
            print(f"Numéro CVE : {cve_info['name']}", file=f)
            print(f"Date de publication : {cve_info['public_date']}", file=f)
            print(f"Description : {cve_info['bugzilla']['description']}", file=f)
            print(f"Details: {cve_info['details']}", file=f)
            print(f"Date de publication : {cve_info['public_date']}", file=f)
            print(f"Gravité: {cve_info['threat_severity']}", file=f)
            print(f"Lien Bugzilla : {cve_info['bugzilla']['url']}", file=f)
            print(f"Score CVSS : {cve_info['cvss3']['cvss3_base_score']}", file=f)
            
        print(f"Numéro CVE : {cve_info['name']}")
        print(f"Date de publication : {cve_info['public_date']}")
        print(f"Description : {cve_info['bugzilla']['description']}")
        print(f"Details: {cve_info['details']}")
        print(f"Date de publication : {cve_info['public_date']}")
        print(f"Gravité: {cve_info['threat_severity']}")
        print(f"Lien Bugzilla : {cve_info['bugzilla']['url']}")
        print(f"Score CVSS : {cve_info['cvss3']['cvss3_base_score']}")
    else:
        print('Erreur lors de la récupération des données :', response.status_code)

while True:
    print("Sélectionnez une option :")
    print("1. Afficher un nombre de CVE spécifique")
    print("2. Afficher des informations sur une CVE précise")
    choice = input("Entrez votre choix : ")

    if choice == '1':
        num_cves = int(input("Combien de CVEs souhaitez-vous afficher ? "))
        print("")
        display_cves(num_cves)
    elif choice == '2':
        cve_id = input("Entrez le numéro CVE de la CVE que vous souhaitez afficher : ")
        print("")
        display_cve_info(cve_id)
    else:
        print("Choix invalide. Veuillez sélectionner une option valide.")
        print("")